#HTTP_HEADER{Content-Type: text/javascript; charset=#CHARSET}


questionList='<div class="result">' +
    '<table class="table table-striped table-hover">' +
        '{{#questions}}' +
        '<tr><td><a href="{{url}}">{{ titre }}</a></td><td>{{ nature }}</td></tr>' +
        '{{/questions}}' +
        '</table>' +
    '</div>';

var renderQuestionListRecherche = function (qs) {
if (qs){

truc=$("input#recherche").val()

$("#result_recherche_acces_rapide")
.empty()
.append(Mustache.to_html(questionList, {questions: qs}))

if (truc !='')
$("#result_recherche_acces_rapide").append('<div class="lien_recherche"><a  class="btn btn-primary btn-sm" href="#URL_PAGE**{recherche,recherche='+truc+'}">Rechercher "'+truc+'" dans l\'ensemble du site</a></div>')

if (qs.length==0){

$('.morphsearch-content').slideUp();
}else{
$('.morphsearch-content').slideDown();
}
}
else{
$('.morphsearch-content').slideUp();
}
}

var index = lunr(function () {

this.use(lunr.fr);
this.field('titre', {boost: 10})
this.field('mots')
this.ref('id')

});



[data=(#LUNR_DATA|json_encode)]




$(document).ready(function(){


var longueur=data.length;
for(i=0;i<longueur;i++){
    index.add(data[i]);
}






var debounce = function (fn) {
var timeout
return function () {
var args = Array.prototype.slice.call(arguments),
ctx = this

clearTimeout(timeout)
timeout = setTimeout(function () {
fn.apply(ctx, args)
}, 200)
}
}


$('input#recherche').bind('keyup', debounce(function () {

results = index.search($(this).val()).slice(0,10).map(function (result) {
truc= data.filter(function (q) { return q.id == parseInt(result.ref, 10) })[0]
truc['url']=calcule_url(result.ref,truc['nature'])

return truc
})

renderQuestionListRecherche(results)
}))





})







function calcule_url(ref,nature){

if (parseInt(ref)>0){
if(nature=='rubrique')
    return '[(#URL_PAGE*{rubrique,id_rubrique=})]'+ref
else
    return '[(#URL_PAGE*{article,id_article=})]'+ref

}
return '';
}
